import dshell
import util
from httpdecoder import HTTPDecoder


class DshellDecoder(HTTPDecoder):

    def __init__(self):
        HTTPDecoder.__init__(self,
                             name='joomla-cve-2015-8562',
                             description='detect and dissect malformed HTTP headers targeting Joomla',
                             filter='tcp and (port 80 or port 8080 or port 8000)',
                             filterfn=lambda ((sip, sp), (dip, dp)): sp in (
                                 80, 8000, 8080) or dp in (80, 8000, 8080),
                             author='bg',
                             )
        self.ioc = 'JFactory::getConfig();exit'

    def parse_cmd(self, data):
        start = data.find('"feed_url";')+11
        end = data.find(self.ioc)
        chunk = data[start:end]

        try:
            cmd = chunk.split(':')[-1]
            return cmd
        except:
            return None

    def HTTPHandler(self, conn, request, response, requesttime, responsetime):
        if not request:
            return

        if self.ioc not in str(request):
            return

        # there is an attempt to exploit Joomla!

        # The Joomla exploit could be sent any HTTP header field
        for hdr in request.headers:
            if self.ioc in request.headers[hdr]:
                cmd = self.parse_cmd(request.headers[hdr])
                if cmd:
                    self.alert('{} -> {}'.format(hdr, cmd), **conn.info())


if __name__ == '__main__':
    dObj = DshellDecoder()
    print dObj
else:
    dObj = DshellDecoder()
